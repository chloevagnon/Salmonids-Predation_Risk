#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#                                                   R codes for :                                                                    #
#"The vulnerability of whitefish (Coregonus lavaretus) to the invasive European catfish (Silurus glanis) in a large peri-Alpine lake"#
#                                                                                                                                    #
# VAGNON Chloe                                                                                                                       #
# September 2021                                                                                                                     #
#                                                                                                                                    #
# This script is factionned into 2 parts:                                                                                            #
#    I) Size-based vulnerability                                                                                                     #
#       a) Infer body size range for consumers                                                                                       #
#       b) Infer the trophic links to obtain the binary matrix and the list of all possible links                                    #
#       c) Calculate interaction probabilities for all links                                                                         #
#       d) Plot the boxplot of trophic links probabilities between S. glanis and C. lavaretus                                        #
#                                                                                                                                    #
#    II) Predation risk                                                                                                              #
#       a) Depth-matching                                                                                                            #
#       b) Metabolism                                                                                                                #
#       c) Predation risk for 0+                                                                                                     #
#       d) Predation risk for Other life stages                                                                                      #
#                                                                                                                                    #
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#


#######################################       I) Size-based Vulnerability       ######################################################

# Load packages
library(stringr)
library(ggplot2)

# Load data and functions for using the aNM 
load("Param_reginvert.Rdata")
load("Param_regvert.Rdata")
source("cv_Functions_aNM.R")

# Load data referencing body size of each S. glanis and each C. lavaretus
# /!\ Body size in the table must be ordered by decreasing body size
load("DATA_BodySize.Rdata")


#### a) Infer body size range for consumers  ######
Niche<-get_niche_attributes(DATA_BodySize$Name,DATA_BodySize$LogT, DATA_BodySize$SubPhylum)

#### b) Infer the trophic links to obtain the binary matrix and the list of all possible links ####
MatTab1<-L_fn2(Niche$name,Niche$n,Niche$c,Niche$low,Niche$high,"YES")
Mat1<-MatTab1[[1]] #Binary matrix
Tab1<-MatTab1[[2]] # Corresponding table of links
  

#### c) Calculate interaction probabilities for all links ####
MatW2aNM<-Weighting(Niche,Mat1)
Tab1$aNM<-c(MatW2aNM[MatW2aNM!=0])

#Delete S. glanis as prey and C. lavaretus as predator i the list 
Tab1<-Tab1[!str_detect(Tab1$Prey,"SIL")&!str_detect(Tab1$Pred,"WHI"),] 
Tab1$Tprey<-(10^Tab1$Log_Size_Prey)/10000 # in centimeters
Tab1$Tpred<-(10^Tab1$Log_Size_Pred)/10000


#### d)Plot the boxplot of trophic links probabilities between S. glanis and C. lavaretus ####
ggplot(data=Tab1,aes(x=as.factor(Tab1$Tprey),y=aNM))+
  geom_boxplot(size=0.7)+
  scale_x_discrete("Whitefish body size (cm)",labels=c(1,seq(5,50,5)))+
  scale_y_continuous("Trophic link probability",limits=c(0,1))+
  theme(panel.background = element_blank(),panel.grid.major.x  = element_line(color = "darkgrey"), 
        panel.grid.major.y  = element_line(color = "darkgrey"),
        axis.text = element_text(size=16,color="black"),
        axis.title = element_text(size=18,color="black"),
        panel.border = element_rect(colour = "black", fill=NA))
  



#######################################       II) Predation risk       ################################################################

#### a) Depth-matching ####
# DATA to load for computing the depth-matching
load("Depth_SIL.Rdata") # DATA on SIL depth
load("Depth_C_0.Rdata") # DATA on 0+ C. lavaretus depth
load("Depth_C_Other.Rdata") # DATA on other C. lavaretus life stages depth

# Function to load
source("cv_Functions_Vul_Salmo.R")


# Plot of the modal depth for S. glanis and range depth  for 0+ and other whitefish life stages
ggplot()+
  geom_errorbar(data=Depth_SIL,aes(x=MonthNum-0.2,y=D_mode*-1,ymin=D_min*-1,ymax=D_max*-1),size=1.9,width=0.25,col="darkblue")+
  geom_point(data=Depth_SIL,aes(x=MonthNum-0.2,y=D_mode*-1),size=5,col="darkblue")+
  geom_errorbar(data=Depth_C_Other,aes(x=MonthNum+0.2,y=D_mean*-1,ymin=D_min*-1,ymax=D_max*-1),size=1.9,width=0.25,col="#CC9900")+ 
  geom_errorbar(data=Depth_C_0,aes(x=MonthNum,y=D_mean*-1,ymin=D_min*-1,ymax=D_max*-1),size=1.9,width=0.25,col="cyan4")+
  scale_y_continuous("Depth (m)",limits = c(-55,0.1),breaks = seq(-55,0,5))+
  scale_x_continuous("",limits = c(2.6,10.4),breaks = seq(3,10,1),labels =Depth_SIL$Month)+
  theme(panel.background = element_blank(),panel.grid.major.x  = element_line(color = "darkgrey"), 
        panel.grid.major.y  = element_line(color = "darkgrey"),
        axis.text = element_text(size=18,color="black"),axis.title = element_text(size=20,color="black"),
        panel.border = element_rect(colour = "black", fill=NA))


# Compute best parameters of fitting the LogNormal probability density function for each month 
MEAN = seq(0.5,log(ceiling(max(Depth_SIL$D_max))),0.01) # INITIATE the mean 
SD = seq(0.05,1,0.01)# INITIATE the sd
DepthAll<-seq(0.5,max(Depth_SIL$D_max),0.01) # INITIATE the total depth range to be covered
Param<-Param_Depth_Matching(DepthAll,Depth_SIL$D_mode,MEAN,SD, Month=Depth_SIL$MonthNum)# Compute the best combination of parameters

#OR use the ones already fitted for these data 
load("Param.Rdata")

# Plot density curves for each studied month for 0+ whitefish 
op <- par(mfrow=c(3,3),mar=c(5,5,2.5,2))
k=0
for(i in as.character(Depth_C_0$MonthNum)){
  k=k+1
  plot(-Param[["Density"]][[i]]$depth~Param[["Density"]][[i]]$Prob,main=unique(Depth_SIL$Month[k]),
       ylab="Depth (m)",xlab="Depth-matching",
       ylim=c(-60,0),xlim=c(0,1),type="l",col="darkblue",lwd=2,cex.lab=2.5,cex.main=2.5,cex.axis=2)
  abline(h=-Depth_SIL$D_mode[k],col="darkblue",lty=2,lwd=2)
  
  points(y=-seq(Depth_C_0$D_min[k],Depth_C_0$D_max[k],1),
         x=Depth_Matching(Param,
                          DepthPrey=seq(Depth_C_0$D_min[k],Depth_C_0$D_max[k],1),
                          Month = Depth_C_0$MonthNum[k],
                          DepthAll=DepthAll)[,3],col="cyan4",pch=19,cex=2)
}

# Plot density curves for each studied month for other whitefish life stages
op <- par(mfrow=c(3,3),mar=c(5,5,2.5,2))
k=0
for(i in as.character(Depth_C_0$MonthNum)){
  k=k+1
  plot(-Param[["Density"]][[i]]$depth~Param[["Density"]][[i]]$Prob,main=unique(Depth_SIL$Month[k]),
       ylab="Depth (m)",xlab="Depth-matching",
       ylim=c(-60,0),xlim=c(0,1),type="l",col="darkblue",lwd=2,cex.lab=2.5,cex.main=2.5,cex.axis=2)
  abline(h=-Depth_SIL$D_mode[k],col="darkblue",lty=2,lwd=2)
  
  points(y=-seq(Depth_C_Other$D_min[k],Depth_C_Other$D_max[k],1),
         x=Depth_Matching(Param,
                          DepthPrey=seq(Depth_C_Other$D_min[k],Depth_C_Other$D_max[k],1),
                          Month = Depth_C_0$MonthNum[k],
                          DepthAll=DepthAll)[,3],col="#CC9900",pch=19,cex=2)
}

#### b) Metabolism ####
# Load temperature data for different months and years
load("TempMonth.Rdata") 

# Compute the maximum metabolism 
Bmax<-basal_metabolism(bodymass=4500,temperature=max(TempMonth$Temp))



#### c) Compute the predation risk for 0+ ####
D_WHI_All_0<-seq(min(Depth_C_0$D_min), max(Depth_C_0$D_max),1)# For all the monthes in the year

vul_all_depth_0<-Depth_Matching(Param=Param,
                                DepthPrey=D_WHI_All_0,
                                Month=3:10, 
                                DepthAll = DepthAll)[,3]

vul_unimod_max_0<-max(vul_all_depth_0)

# Compute Vulnerability 
Vulnerability_0<-data.frame(Year=NA,Month=NA,MonthNum=NA,Temp=NA,Depth=NA,vul_unimod=NA)
for (i in 1:nrow(TempMonth)){
  
  # Find metabolism (test with sil= 4.5 Kg)
  B<-basal_metabolism(bodymass=4500,temperature=TempMonth$Temp[i])
  
  
  D_WHI<-seq(Depth_C_0$D_min[Depth_C_0$MonthNum==TempMonth$MonthNum[i]],Depth_C_0$D_max[Depth_C_0$MonthNum==TempMonth$MonthNum[i]],1)
  vul_unimod<-(Depth_Matching(Param,D_WHI,TempMonth$MonthNum[i])[,3]/vul_unimod_max_0)*(B/Bmax)
  
  
  Vul<-data.frame(Year=TempMonth$Year[i],Month=TempMonth$Month[i],MonthNum=TempMonth$MonthNum[i],
                  Temp=TempMonth$Temp[i],Depth=D_WHI,vul_unimod=vul_unimod)
  
  Vulnerability_0<-rbind(Vulnerability_0,Vul)
  
}
Vulnerability_0<-na.omit(Vulnerability_0)

# Plot the results
pos <-unique(TempMonth$Month)
ggplot(data=Vulnerability_0,aes(x=Month,y=vul_unimod,fill=Year))+
  geom_boxplot(position = "dodge")+
  scale_y_continuous("Predation risk",limits=c(0,1),breaks=seq(0,1,0.1))+
  scale_x_discrete("",limits=pos)+
  theme(panel.background = element_blank(),panel.grid.major.x  = element_line(color = "darkgrey"), 
        panel.grid.major.y  = element_line(color = "darkgrey"),
        axis.text = element_text(size=18,color="black"),axis.title = element_text(size=20,color="black"),
        panel.border = element_rect(colour = "black", fill=NA))



#### d) Compute the predation risk for Other whitefish life stages ####
D_WHI_AllOther<-seq(min(Depth_C_Other$D_min), max(Depth_C_Other$D_max),1)# For all the monthes in the year
vul_all_depthOther<-Depth_Matching(Param=Param,
                                   DepthPrey=D_WHI_AllOther,
                                   Month=3:10, 
                                   DepthAll = DepthAll)[,3]

vul_unimod_maxOther<-max(vul_all_depthOther)

# Compute Vulnerability 
VulnerabilityOther<-data.frame(Year=NA,Month=NA,MonthNum=NA,Temp=NA,Depth=NA,vul_unimod=NA)
for (i in 1:nrow(TempMonth)){
  
  # Find metabolism (test with sil= 4.5Kg)
  B<-basal_metabolism(bodymass=4500,temperature=TempMonth$Temp[i])
  
  
  D_WHI<-seq(Depth_C_Other$D_min[Depth_C_Other$MonthNum==TempMonth$MonthNum[i]],Depth_C_Other$D_max[Depth_C_Other$MonthNum==TempMonth$MonthNum[i]],1)
  vul_unimod<-(Depth_Matching(Param,D_WHI,TempMonth$MonthNum[i])[,3]/vul_unimod_maxOther)*(B/Bmax)
  
  
  Vul<-data.frame(Year=TempMonth$Year[i],Month=TempMonth$Month[i],MonthNum=TempMonth$MonthNum[i],
                  Temp=TempMonth$Temp[i],Depth=D_WHI,vul_unimod=vul_unimod)
  
  VulnerabilityOther<-rbind(VulnerabilityOther,Vul)
  
}
VulnerabilityOther<-na.omit(VulnerabilityOther)

# Plot the results
ggplot(data=VulnerabilityOther,aes(x=Month,y=vul_unimod,fill=Year))+
  geom_boxplot(position = "dodge")+
  scale_y_continuous("Predation risk",limits=c(0,1),breaks=seq(0,1,0.1))+
  scale_x_discrete("",limits=pos)+
  theme(panel.background = element_blank(),panel.grid.major.x  = element_line(color = "darkgrey"), 
        panel.grid.major.y  = element_line(color = "darkgrey"),
        axis.text = element_text(size=18,color="black"),axis.title = element_text(size=20,color="black"),
        panel.border = element_rect(colour = "black", fill=NA))        

